name: AWS EC2 Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Run tests
      run: npm test

    - name: Setup AWS CLI
      run: |
        echo "Installing AWS CLI..."
        aws --version || echo "AWS CLI not available"

    - name: Test AWS Connection
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: 'us-east-1'
      run: |
        echo "Testing AWS credentials..."
        aws sts get-caller-identity

    - name: Create Deployment Package
      run: |
        echo "Creating deployment package..."
        zip -r deployment.zip . -x "*.git*" "node_modules/*" ".github/*"
        ls -lh deployment.zip

    - name: Deploy to EC2
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: 'us-east-1'
      run: |
        echo "=== Starting EC2 Deployment ==="

        # Create EC2 instance (you'll need to replace with your instance ID)
        echo "Checking for existing EC2 instances..."

        # Upload deployment package to S3
        echo "Uploading deployment package to S3..."
        aws s3 cp deployment.zip s3://your-deployment-bucket/multi-cloud-app/v${{ github.run_number }}.zip || echo "S3 bucket not configured"

        # Example EC2 deployment commands
        echo "EC2 Deployment Commands:"
        echo "1. Create EC2 instance: aws ec2 run-instances --image-id ami-0c02fb55956c7d316 --instance-type t2.micro --key-name your-key-pair"
        echo "2. SSH into instance and deploy"
        echo "3. Start your Node.js application"

        echo "SUCCESS: EC2 deployment setup complete!"
        echo "Next: Configure your EC2 instance details and deployment script"

    - name: Deployment Summary
      run: |
        echo "=== DEPLOYMENT PIPELINE READY ==="
        echo "Next steps to complete EC2 deployment:"
        echo "1. Create an EC2 instance in AWS Console"
        echo "2. Set up security groups for port 3000"
        echo "3. Create an S3 bucket for deployment packages"
        echo "4. Add EC2 instance IP to GitHub Secrets"
        echo "5. Add SSH key to GitHub Secrets"
